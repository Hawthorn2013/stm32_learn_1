#include "oled.h"

//OLED需要的板集接口
extern void OLED_Reset(void);
extern void OLED_Init(void);
extern void OLED_SendCmd(uint8_t cmd);
extern void OLED_SendData(uint8_t data);

#if OLED_CONF_USE_MEMORY
static uint8_t OLED_memory[OLED_PAGE][OLED_SEG];
#endif

//内部使用的函数
static uint16_t Pos_X, Pos_Y;
static void OLED_SendCmd_SetPos(uint8_t x, uint8_t y);
static void OLED_WriteGraphData(uint8_t data);

void OLED_Init(void)
{
    OLED_SendCmd(0xae);//--turn off oled panel
    //--
//	OLED_SendCmd(0x00);//---set low column address
    //--
//	OLED_SendCmd(0x10);//---set high column address
    //--
	OLED_SendCmd(0x40);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
    //--
	OLED_SendCmd(0x81);//--set contrast control register
	OLED_SendCmd(0xcf); // Set SEG Output Current Brightness
    //--
	OLED_SendCmd(0xa1);//--Set SEG/Column Mapping     0xa0左右反置 0xa1正常
    //--
	OLED_SendCmd(0xc8);//Set COM/Row Scan Direction   0xc0上下反置 0xc8正常
    //--
	OLED_SendCmd(0xa6);//--set normal display
    //--
	OLED_SendCmd(0xa8);//--set multiplex ratio(1 to 64)
	OLED_SendCmd(0x3f);//--1/64 duty
    //--
	OLED_SendCmd(0xd3);//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
	OLED_SendCmd(0x00);//-not offset
    //--
	OLED_SendCmd(0xd5);//--set display clock divide ratio/oscillator frequency
	OLED_SendCmd(0x80);//--set divide ratio, Set Clock as 100 Frames/Sec
    //--
	OLED_SendCmd(0xd9);//--set pre-charge period
	OLED_SendCmd(0xf1);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
    //--
	OLED_SendCmd(0xda);//--set com pins hardware configuration
	OLED_SendCmd(0x12);
    //--
	OLED_SendCmd(0xdb);//--set vcomh
	OLED_SendCmd(0x40);//Set VCOM Deselect Level
    //--
	OLED_SendCmd(0x20);//-Set Page Addressing Mode (0x00/0x01/0x02)
	OLED_SendCmd(0x00);//
    //--
	OLED_SendCmd(0x8d);//--set Charge Pump enable/disable
	OLED_SendCmd(0x14);//--set(0x10) disable
    //--
	OLED_SendCmd(0xa4);// Disable Entire Display On (0xa4/0xa5)
    //--
	OLED_SendCmd(0xa6);// Disable Inverse Display On (0xa6/a7)
    //--
	OLED_SendCmd(0xaf);//--turn on oled panel
    //--
}

void OLED_Fill(uint8_t data)
{
	uint8_t y, x;
    
	for(y = 0; y < 8; y++)
	{
		OLED_SendCmd(0xb0 + y);
		OLED_SendCmd(0x01);
		OLED_SendCmd(0x10);
		for(x = 0 ;x < 128; x++)
			OLED_SendData(data);
	}
}

const static uint8_t Font_ascii_6x8[][6] =
{
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },   // sp
    { 0x00, 0x00, 0x00, 0x2f, 0x00, 0x00 },   // !
    { 0x00, 0x00, 0x07, 0x00, 0x07, 0x00 },   // "
    { 0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14 },   // #
    { 0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12 },   // $
    { 0x00, 0x62, 0x64, 0x08, 0x13, 0x23 },   // %
    { 0x00, 0x36, 0x49, 0x55, 0x22, 0x50 },   // &
    { 0x00, 0x00, 0x05, 0x03, 0x00, 0x00 },   // '
    { 0x00, 0x00, 0x1c, 0x22, 0x41, 0x00 },   // (
    { 0x00, 0x00, 0x41, 0x22, 0x1c, 0x00 },   // )
    { 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14 },   // *
    { 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08 },   // +
    { 0x00, 0x00, 0x00, 0xA0, 0x60, 0x00 },   // ,
    { 0x00, 0x08, 0x08, 0x08, 0x08, 0x08 },   // -
    { 0x00, 0x00, 0x60, 0x60, 0x00, 0x00 },   // .
    { 0x00, 0x20, 0x10, 0x08, 0x04, 0x02 },   // /
    { 0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E },   // 0
    { 0x00, 0x00, 0x42, 0x7F, 0x40, 0x00 },   // 1
    { 0x00, 0x42, 0x61, 0x51, 0x49, 0x46 },   // 2
    { 0x00, 0x21, 0x41, 0x45, 0x4B, 0x31 },   // 3
    { 0x00, 0x18, 0x14, 0x12, 0x7F, 0x10 },   // 4
    { 0x00, 0x27, 0x45, 0x45, 0x45, 0x39 },   // 5
    { 0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30 },   // 6
    { 0x00, 0x01, 0x71, 0x09, 0x05, 0x03 },   // 7
    { 0x00, 0x36, 0x49, 0x49, 0x49, 0x36 },   // 8
    { 0x00, 0x06, 0x49, 0x49, 0x29, 0x1E },   // 9
    { 0x00, 0x00, 0x36, 0x36, 0x00, 0x00 },   // :
    { 0x00, 0x00, 0x56, 0x36, 0x00, 0x00 },   // ;
    { 0x00, 0x08, 0x14, 0x22, 0x41, 0x00 },   // <
    { 0x00, 0x14, 0x14, 0x14, 0x14, 0x14 },   // =
    { 0x00, 0x00, 0x41, 0x22, 0x14, 0x08 },   // >
    { 0x00, 0x02, 0x01, 0x51, 0x09, 0x06 },   // ?
    { 0x00, 0x32, 0x49, 0x59, 0x51, 0x3E },   // @
    { 0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C },   // A
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x36 },   // B
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x22 },   // C
    { 0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C },   // D
    { 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41 },   // E
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x01 },   // F
    { 0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A },   // G
    { 0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F },   // H
    { 0x00, 0x00, 0x41, 0x7F, 0x41, 0x00 },   // I
    { 0x00, 0x20, 0x40, 0x41, 0x3F, 0x01 },   // J
    { 0x00, 0x7F, 0x08, 0x14, 0x22, 0x41 },   // K
    { 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40 },   // L
    { 0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F },   // M
    { 0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F },   // N
    { 0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E },   // O
    { 0x00, 0x7F, 0x09, 0x09, 0x09, 0x06 },   // P
    { 0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E },   // Q
    { 0x00, 0x7F, 0x09, 0x19, 0x29, 0x46 },   // R
    { 0x00, 0x46, 0x49, 0x49, 0x49, 0x31 },   // S
    { 0x00, 0x01, 0x01, 0x7F, 0x01, 0x01 },   // T
    { 0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F },   // U
    { 0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F },   // V
    { 0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F },   // W
    { 0x00, 0x63, 0x14, 0x08, 0x14, 0x63 },   // X
    { 0x00, 0x07, 0x08, 0x70, 0x08, 0x07 },   // Y
    { 0x00, 0x61, 0x51, 0x49, 0x45, 0x43 },   // Z
    { 0x00, 0x00, 0x7F, 0x41, 0x41, 0x00 },   // [
    { 0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55 },   // 55
    { 0x00, 0x00, 0x41, 0x41, 0x7F, 0x00 },   // ]
    { 0x00, 0x04, 0x02, 0x01, 0x02, 0x04 },   // ^
    { 0x00, 0x40, 0x40, 0x40, 0x40, 0x40 },   // _
    { 0x00, 0x00, 0x01, 0x02, 0x04, 0x00 },   // '
    { 0x00, 0x20, 0x54, 0x54, 0x54, 0x78 },   // a
    { 0x00, 0x7F, 0x48, 0x44, 0x44, 0x38 },   // b
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x20 },   // c
    { 0x00, 0x38, 0x44, 0x44, 0x48, 0x7F },   // d
    { 0x00, 0x38, 0x54, 0x54, 0x54, 0x18 },   // e
    { 0x00, 0x08, 0x7E, 0x09, 0x01, 0x02 },   // f
    { 0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C },   // g
    { 0x00, 0x7F, 0x08, 0x04, 0x04, 0x78 },   // h
    { 0x00, 0x00, 0x44, 0x7D, 0x40, 0x00 },   // i
    { 0x00, 0x40, 0x80, 0x84, 0x7D, 0x00 },   // j
    { 0x00, 0x7F, 0x10, 0x28, 0x44, 0x00 },   // k
    { 0x00, 0x00, 0x41, 0x7F, 0x40, 0x00 },   // l
    { 0x00, 0x7C, 0x04, 0x18, 0x04, 0x78 },   // m
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x78 },   // n
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x38 },   // o
    { 0x00, 0xFC, 0x24, 0x24, 0x24, 0x18 },   // p
    { 0x00, 0x18, 0x24, 0x24, 0x18, 0xFC },   // q
    { 0x00, 0x7C, 0x08, 0x04, 0x04, 0x08 },   // r
    { 0x00, 0x48, 0x54, 0x54, 0x54, 0x20 },   // s
    { 0x00, 0x04, 0x3F, 0x44, 0x40, 0x20 },   // t
    { 0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C },   // u
    { 0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C },   // v
    { 0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C },   // w
    { 0x00, 0x44, 0x28, 0x10, 0x28, 0x44 },   // x
    { 0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C },   // y
    { 0x00, 0x44, 0x64, 0x54, 0x4C, 0x44 },   // z
    { 0x14, 0x14, 0x14, 0x14, 0x14, 0x14 },   // horiz lines
    { 0x00, 0x7e, 0x7e, 0x7e, 0x7e, 0x00 }
};

void OLED_Print6x8Str(const uint8_t str[])
{
    uint16_t i = 0, j = 0;
    uint8_t ch;
    uint16_t x = Pos_X, y = Pos_Y;
    
    for(ch = str[i]; str[i]; i++)
    {
        ch = str[i];
        //字符不在字库中
        if(ch == '\n')
        {
            OLED_SetPos(x = 0, ++y);
            continue;
        }
        else if(ch == '\r')
        {
            OLED_SetPos(x = 0, y);
            continue;
        }
        else if(ch < ' ' || ch > 'z')
        {
            ch = (uint8_t)(sizeof(Font_ascii_6x8) / 6) + (uint8_t)' ' - (uint8_t)1;
        }
        //行末空间不足，自动换行
        if(OLED_SEG - Pos_X < 6)
        {
            OLED_SetPos(x = 0, ++y);
        }
        for(j = 0; j < 6; j++)
        {
            OLED_WriteGraphData(Font_ascii_6x8[ch - ' '][j]);
            OLED_SetPos(++x, y);
        }
    }
}

void OLED_SetPos(uint8_t x, uint8_t y)
{
    Pos_X = x % OLED_SEG;
    Pos_Y = y % OLED_PAGE;
    #if !OLED_CONF_USE_MEMORY
    OLED_SendCmd_SetPos(Pos_X, Pos_Y);
    #endif
}

#if OLED_CONF_USE_MEMORY
void OLED_UpdateMemory(void)
{
    uint16_t i;
    OLED_SetPos(0, 0);
    for(i = 0; i < OLED_SEG * OLED_PAGE; i++)
    {
        OLED_SendData(((const uint8_t *)OLED_memory)[i]);
    }
}
#endif

static void OLED_SendCmd_SetPos(uint8_t x, uint8_t y)
{
	OLED_SendCmd(0xb0 + y);
	OLED_SendCmd(((x & 0xf0) >> 4) | 0x10);
	OLED_SendCmd((x & 0x0f) | 0x00);
}

static void OLED_WriteGraphData(uint8_t data)
{
    #if OLED_CONF_USE_MEMORY
    OLED_memory[Pos_Y][Pos_X] = data;
    #else
    OLED_SendData(data);
    #endif
}
